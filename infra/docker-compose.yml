services:
  postgres:
    image: postgres:16
    environment: [POSTGRES_PASSWORD=devpw, POSTGRES_USER=dev, POSTGRES_DB=iot]
    ports: ["5432:5432"]
    volumes: ["pg:/var/lib/postgresql/data"]

  mosquitto:
    build:
      context: ./mqtt
    ports: ["1883:1883"]

  app:
    build: ../server
    environment:
      - DATABASE_URL=postgresql+psycopg://dev:devpw@postgres:5432/iot
      - MQTT_BROKER=mosquitto
    depends_on: [postgres, mosquitto]
    ports: ["8000:8000"]
    volumes:
      - ../server:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  web:
    build: ../web
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on: [app]
    ports: ["5173:5173"]
    volumes:
      - ../web:/app
      - /app/node_modules

volumes: { pg: {} }
