services:
  postgres:
    image: postgres:16
    environment: [POSTGRES_PASSWORD=devpw, POSTGRES_USER=dev, POSTGRES_DB=iot]
    ports: ["5432:5432"]
    volumes: ["pg:/var/lib/postgresql/data"]
  mosquitto:
    image: eclipse-mosquitto:2
    ports: ["1883:1883"]
    volumes: ["./mosquitto.conf:/mosquitto/config/mosquitto.conf"]
  app:
    build: ../server
    environment:
      - DATABASE_URL=postgresql+psycopg://dev:devpw@postgres:5432/iot
      - MQTT_BROKER=mosquitto
    depends_on: [postgres, mosquitto]
    ports: ["8000:8000"]
  web:
    image: node:20
    working_dir: /app
    volumes: ["../web:/app"]
    command: ["sh", "-c", "npm install && npx concurrently -n vite,json \"vite --host 0.0.0.0 --port 55080\" \"json-server --host 0.0.0.0 --watch mock.json --port 9000\""]
    environment: ["WEB_PORT=55080"]
    ports:
      - "127.0.0.1:55080:55080"
      - "127.0.0.1:9000:9000"

volumes: { pg: {} }
